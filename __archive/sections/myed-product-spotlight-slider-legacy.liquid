{% comment %}
  MyED â€” NUE Product Slider (Stabil v2)
  Goals:
  - Single marquee engine (translate3d ticker)
  - Track renders items twice (A + B) => deterministic loopWidth
  - Titles: hidden by default; desktop hover/focus; mobile first tap reveals, second tap navigates
  - Mobile/Desktop background via 2 images only (picture source)
  - Theme Editor stable (single instance guard + rebuild hooks)
  Notes:
  - No external libs, minimal vanilla JS
{% endcomment %}

{{ 'myed-nue-product-slider.css' | asset_url | stylesheet_tag }}

{%- liquid
  assign s = section.settings
  assign source = s.source
  assign aspect_d_raw = s.aspect_ratio | default: '4 / 5'
  assign aspect_m_raw = s.media_aspect_mobile | default: s.aspect_ratio
  assign aspect_d = aspect_d_raw | replace: ':', '/'
  assign aspect_m = aspect_m_raw | replace: ':', '/'
  if aspect_m == blank
    assign aspect_m = aspect_d
  endif
-%}

<section
  id="myed-nue-{{ section.id }}"
  class="myed-nue{% if s.orbit_enable %} has-orbit{% endif %}{% if s.show_title %} has-title{% endif %}"
  style="background: {{ s.bg_color }}; --myed-heading-color: {{ s.heading_color }}; --nue-aspect-d: {{ aspect_d }}; --nue-aspect-m: {{ aspect_m }};"
  data-section-id="{{ section.id }}"
  data-myed-nue
>
  {%- if s.bg_desktop != blank or s.bg_mobile != blank -%}
    <picture class="myed-nue__bg" aria-hidden="true">
      {%- if s.bg_mobile != blank -%}
        <source
          media="(max-width: 749px)"
          srcset="
            {{ s.bg_mobile | image_url: width: 800 }} 800w,
            {{ s.bg_mobile | image_url: width: 1200 }} 1200w,
            {{ s.bg_mobile | image_url: width: 1600 }} 1600w
          "
          sizes="100vw"
        >
      {%- endif -%}

      {%- if s.bg_desktop != blank -%}
        <img
          src="{{ s.bg_desktop | image_url: width: 2400 }}"
          srcset="
            {{ s.bg_desktop | image_url: width: 1200 }} 1200w,
            {{ s.bg_desktop | image_url: width: 1800 }} 1800w,
            {{ s.bg_desktop | image_url: width: 2400 }} 2400w
          "
          sizes="100vw"
          width="{{ s.bg_desktop.width }}"
          height="{{ s.bg_desktop.height }}"
          loading="lazy"
          decoding="async"
          alt=""
        >
      {%- else -%}
        <img
          src="{{ s.bg_mobile | image_url: width: 1600 }}"
          width="{{ s.bg_mobile.width }}"
          height="{{ s.bg_mobile.height }}"
          loading="lazy"
          decoding="async"
          alt=""
        >
      {%- endif -%}
    </picture>
  {%- endif -%}

  {%- if s.orbit_enable -%}
    <div class="myed-nue__orbit" aria-hidden="true"></div>
  {%- endif -%}

  <div class="myed-nue__inner">
    {%- if s.heading != blank -%}
      <h2 class="myed-nue__heading">{{ s.heading }}</h2>
    {%- endif -%}

    {%- capture myed_items -%}
      {%- if source == 'collection' -%}
        {%- if s.collection != blank -%}
          {%- for product in s.collection.products limit: s.limit_collection -%}
            {%- liquid
              assign img = product.featured_image
              if img == blank and product.featured_media != blank
                assign img = product.featured_media.preview_image
              endif
            -%}
            <div class="myed-nue__item" data-myed-nue-item>
              <div class="myed-nue__itemInner">
                <a class="myed-nue__link" href="{{ product.url }}" aria-label="{{ product.title | escape }}">
                  <div class="myed-nue__media">
                    {%- if img != blank -%}
                      {{ img | image_url: width: 1400 | image_tag: loading: 'lazy', decoding: 'async', alt: product.title }}
                    {%- else -%}
                      {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
                    {%- endif -%}
                  </div>

                  {%- if s.show_title -%}
                    <div class="myed-nue__meta" aria-hidden="true">
                      <p class="myed-nue__title">{{ product.title }}</p>
                    </div>
                  {%- endif -%}
                </a>
              </div>
            </div>
          {%- endfor -%}
        {%- else -%}
          {%- for i in (1..8) -%}
            <div class="myed-nue__item" data-myed-nue-item>
              <div class="myed-nue__itemInner">
                <a class="myed-nue__link" href="#" aria-label="Product {{ i }}">
                  <div class="myed-nue__media">
                    {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
                  </div>
                  {%- if s.show_title -%}
                    <div class="myed-nue__meta" aria-hidden="true">
                      <p class="myed-nue__title">Product {{ i }}</p>
                    </div>
                  {%- endif -%}
                </a>
              </div>
            </div>
          {%- endfor -%}
        {%- endif -%}
      {%- else -%}
        {%- assign count = 0 -%}
        {%- for block in section.blocks -%}
          {%- if block.type == 'product' and block.settings.product != blank -%}
            {%- assign count = count | plus: 1 -%}
            {%- if count <= s.limit_manual -%}
              {%- assign product = block.settings.product -%}
              {%- liquid
                assign img = product.featured_image
                if img == blank and product.featured_media != blank
                  assign img = product.featured_media.preview_image
                endif
              -%}
              <div class="myed-nue__item" data-myed-nue-item {{ block.shopify_attributes }}>
                <div class="myed-nue__itemInner">
                  <a class="myed-nue__link" href="{{ product.url }}" aria-label="{{ product.title | escape }}">
                    <div class="myed-nue__media">
                      {%- if img != blank -%}
                        {{ img | image_url: width: 1400 | image_tag: loading: 'lazy', decoding: 'async', alt: product.title }}
                      {%- else -%}
                        {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
                      {%- endif -%}
                    </div>
                    {%- if s.show_title -%}
                      <div class="myed-nue__meta" aria-hidden="true">
                        <p class="myed-nue__title">{{ product.title }}</p>
                      </div>
                    {%- endif -%}
                  </a>
                </div>
              </div>
            {%- endif -%}
          {%- endif -%}
        {%- endfor -%}

        {%- if count == 0 -%}
          {%- for i in (1..8) -%}
            <div class="myed-nue__item" data-myed-nue-item>
              <div class="myed-nue__itemInner">
                <a class="myed-nue__link" href="#" aria-label="Manual Product {{ i }}">
                  <div class="myed-nue__media">
                    {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
                  </div>
                  {%- if s.show_title -%}
                    <div class="myed-nue__meta" aria-hidden="true">
                      <p class="myed-nue__title">Manual Product {{ i }}</p>
                    </div>
                  {%- endif -%}
                </a>
              </div>
            </div>
          {%- endfor -%}
        {%- endif -%}
      {%- endif -%}
    {%- endcapture -%}

    <div
      class="myed-nue__viewport"
      data-myed-nue-viewport
      data-speed-desktop="{{ s.speed_desktop }}"
      data-speed-mobile="{{ s.speed_mobile }}"
      data-resume-delay="{{ s.resume_delay }}"
      data-pause-hover="{{ s.pause_on_hover }}"
      data-focus-scale="{{ s.focus_scale }}"
      data-show-title="{{ s.show_title }}"
      data-debug="{{ s.debug }}"
      style="
        --myed-card-w: {{ s.card_width_desktop }}px;
        --myed-card-w-m: {{ s.card_width_mobile }}px;
        --myed-gap: {{ s.gap_desktop }}px;
        --myed-gap-m: {{ s.gap_mobile }}px;
        --myed-ar: {{ s.aspect_ratio }};
      "
    >
      <div class="myed-nue__track" data-myed-nue-track>
        <div class="myed-nue__group" data-myed-nue-group-a>
          {{ myed_items }}
        </div>

        <div class="myed-nue__group" data-myed-nue-group-b aria-hidden="true">
          {{ myed_items }}
        </div>
      </div>
    </div>
  </div>

  <script>
    (() => {
      const root = document.getElementById('myed-nue-{{ section.id }}');
      if (!root) return;

      // Kill previous instance if re-rendered (Theme Editor)
      if (root._myedNue && typeof root._myedNue.destroy === 'function') {
        root._myedNue.destroy();
      }

      const viewport = root.querySelector('[data-myed-nue-viewport]');
      const track = root.querySelector('[data-myed-nue-track]');
      const groupA = root.querySelector('[data-myed-nue-group-a]');
      const groupB = root.querySelector('[data-myed-nue-group-b]');
      if (!viewport || !track || !groupA || !groupB) return;

      const sectionId = root.dataset.sectionId;
      const designMode = !!(window.Shopify && Shopify.designMode);

      const mqMobile = () => window.matchMedia && window.matchMedia('(max-width: 749px)').matches;
      const mqCanHover = () => window.matchMedia && window.matchMedia('(hover:hover)').matches;
      const mqCoarse = () => window.matchMedia && window.matchMedia('(pointer:coarse)').matches;
      const prefersReduced = () => window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

      const settings = {
        speedDesktop: Number(viewport.dataset.speedDesktop || 110),
        speedMobile: Number(viewport.dataset.speedMobile || 70),
        resumeDelay: Number(viewport.dataset.resumeDelay || 1200),
        pauseOnHover: viewport.dataset.pauseHover === 'true',
        focusScalePct: Number(viewport.dataset.focusScale || 7),
        showTitle: viewport.dataset.showTitle === 'true',
        debug: viewport.dataset.debug === 'true'
      };

      const state = {
        raf: 0,
        lastTs: 0,
        offset: 0,
        loopWidth: 0,
        dragCandidate: false,
        dragging: false,
        didDrag: false,
        startX: 0,
        startOffset: 0,
        pausedHover: false,
        pausedInteract: false,
        resumeTimer: 0,
        resizeTimer: 0,
        cleanup: [],
        // title tap logic
        activeItem: null,
        lastTapLink: null,
        lastTapAt: 0,
        // center scale throttle
        lastScaleAt: 0
      };
      const dragThreshold = 8;

      const addCleanup = (fn) => state.cleanup.push(fn);

      function logOnce(msg) {
        if (settings.debug || designMode) console.log(msg);
      }

      function getSpeed() {
        const v = mqMobile() ? settings.speedMobile : settings.speedDesktop;
        return Math.max(0, Number(v) || 0);
      }

      function applyTransform() {
        track.style.transform = `translate3d(${state.offset}px, 0, 0)`;
      }

      function wrapOffset() {
        if (!state.loopWidth) return;
        while (state.offset <= -state.loopWidth) state.offset += state.loopWidth;
        while (state.offset > 0) state.offset -= state.loopWidth;
      }

      function setPausedClass(isPaused) {
        root.classList.toggle('is-paused', !!isPaused);
      }

      function shouldRun() {
        if (prefersReduced()) return false;
        if (state.dragging) return false;
        if (state.pausedHover) return false;
        if (state.pausedInteract) return false;
        if (getSpeed() <= 0) return false;
        return true;
      }

      function disableTabbingInGroupB() {
        const focusables = groupB.querySelectorAll('a, button, input, select, textarea, [tabindex]');
        focusables.forEach((el) => {
          el.setAttribute('tabindex', '-1');
        });
      }

      function rebuildLoop(attempt = 0) {
        // loopWidth must be based on groupA only
        state.loopWidth = groupA.scrollWidth;

        if (!state.loopWidth || viewport.clientWidth === 0) {
          // Theme editor / initial render can report 0 briefly => retry a few times
          if (attempt < 8) {
            requestAnimationFrame(() => rebuildLoop(attempt + 1));
          }
          return;
        }

        // keep offset stable
        state.offset = 0;
        wrapOffset();
        applyTransform();

        disableTabbingInGroupB();

        logOnce(`[MyED NUE] running | loopWidth=${Math.round(state.loopWidth)} | speed=${getSpeed()}px/s`);
      }

      function resumeAfterDelay() {
        if (state.resumeTimer) clearTimeout(state.resumeTimer);
        state.resumeTimer = setTimeout(() => {
          state.pausedInteract = false;
          setPausedClass(state.pausedHover || state.pausedInteract || state.dragging);
        }, settings.resumeDelay);
      }

      function applyCenterScale(ts) {
        if (!settings.focusScalePct || settings.focusScalePct <= 0) return;

        // throttle (performance)
        if (ts && (ts - state.lastScaleAt) < 80) return;
        state.lastScaleAt = ts || performance.now();

        const items = root.querySelectorAll('[data-myed-nue-item]');
        if (!items || !items.length) return;

        const vp = viewport.getBoundingClientRect();
        const centerX = vp.left + vp.width / 2;
        const half = Math.max(1, vp.width / 2);
        const peak = Math.max(0, settings.focusScalePct) / 100;

        for (const item of items) {
          const r = item.getBoundingClientRect();
          const c = r.left + r.width / 2;
          const d = Math.abs(centerX - c);
          const t = Math.min(d / half, 1);
          const s = 1 + peak * (1 - t);
          item.style.setProperty('--myed-scale', s.toFixed(3));
        }
      }

      function tick(ts) {
        state.raf = requestAnimationFrame(tick);

        const dt = state.lastTs ? Math.min(ts - state.lastTs, 32) : 16;
        state.lastTs = ts;

        if (shouldRun()) {
          state.offset -= (getSpeed() / 1000) * dt;
          wrapOffset();
          applyTransform();
        } else {
          applyTransform();
        }

        applyCenterScale(ts);
      }

      // ---- Drag ----
      function onPointerDown(e) {
        if (e.pointerType === 'mouse' && e.button !== 0) return;

        state.dragCandidate = true;
        state.dragging = false;
        state.didDrag = false;
        state.startX = e.clientX;
        state.startOffset = state.offset;
      }

      function onPointerMove(e) {
        if (!state.dragCandidate && !state.dragging) return;

        const dx = e.clientX - state.startX;
        if (!state.dragging) {
          if (Math.abs(dx) <= dragThreshold) return;
          state.dragging = true;
          state.didDrag = true;
          state.pausedInteract = true;
          setPausedClass(true);
          viewport.classList.add('is-dragging');
          try { viewport.setPointerCapture(e.pointerId); } catch (err) {}
        }

        state.offset = state.startOffset + dx;
        wrapOffset();
        applyTransform();
      }

      function onPointerUp() {
        if (!state.dragCandidate && !state.dragging) return;
        const wasDragging = state.dragging;

        state.dragCandidate = false;
        state.dragging = false;
        viewport.classList.remove('is-dragging');

        if (wasDragging) {
          // keep paused briefly then resume
          state.pausedInteract = true;
          setPausedClass(true);
          resumeAfterDelay();
        }
      }

      viewport.addEventListener('pointerdown', onPointerDown, { passive: true });
      window.addEventListener('pointermove', onPointerMove, { passive: true });
      window.addEventListener('pointerup', onPointerUp, { passive: true });
      window.addEventListener('pointercancel', onPointerUp, { passive: true });

      addCleanup(() => viewport.removeEventListener('pointerdown', onPointerDown));
      addCleanup(() => window.removeEventListener('pointermove', onPointerMove));
      addCleanup(() => window.removeEventListener('pointerup', onPointerUp));
      addCleanup(() => window.removeEventListener('pointercancel', onPointerUp));

      // Prevent accidental navigation while dragging
      function onClickCapture(e) {
        if (state.didDrag) {
          e.preventDefault();
          e.stopPropagation();
          state.didDrag = false;
        }
      }
      viewport.addEventListener('click', onClickCapture, true);
      addCleanup(() => viewport.removeEventListener('click', onClickCapture, true));

      // ---- Hover pause (desktop) ----
      if (settings.pauseOnHover) {
        const onEnter = () => {
          if (mqMobile()) return;
          if (!mqCanHover()) return;
          state.pausedHover = true;
          setPausedClass(true);
        };
        const onLeave = () => {
          if (mqMobile()) return;
          if (!mqCanHover()) return;
          state.pausedHover = false;
          setPausedClass(state.pausedHover || state.pausedInteract || state.dragging);
        };

        viewport.addEventListener('mouseenter', onEnter);
        viewport.addEventListener('mouseleave', onLeave);

        addCleanup(() => viewport.removeEventListener('mouseenter', onEnter));
        addCleanup(() => viewport.removeEventListener('mouseleave', onLeave));
      }

      // ---- Title: mobile first tap reveal, second tap navigate ----
      function setActiveItem(item) {
        if (!settings.showTitle || !item) return;
        if (state.activeItem && state.activeItem !== item) state.activeItem.classList.remove('is-active');
        state.activeItem = item;
        item.classList.add('is-active');

        // Pause briefly so title can be read
        state.pausedInteract = true;
        setPausedClass(true);
        resumeAfterDelay();
      }

      function onLinkClick(e) {
        if (!settings.showTitle) return;
        if (state.didDrag) return;

        const link = e.target.closest('.myed-nue__link');
        if (!link || !viewport.contains(link)) return;

        // Only enforce two-tap on coarse pointers (touch)
        if (!mqCoarse()) return;

        const item = link.closest('.myed-nue__item');
        if (!item) return;

        const now = Date.now();
        const sameLink = (state.lastTapLink === link);
        const withinWindow = (now - state.lastTapAt) < 1400;
        const alreadyActive = item.classList.contains('is-active');

        if (!(alreadyActive && sameLink && withinWindow)) {
          e.preventDefault();
          setActiveItem(item);
          state.lastTapLink = link;
          state.lastTapAt = now;
        } // else: allow navigation
      }

      viewport.addEventListener('click', onLinkClick);
      addCleanup(() => viewport.removeEventListener('click', onLinkClick));

      // ---- Resize rebuild (debounced) ----
      function onResize() {
        if (state.resizeTimer) clearTimeout(state.resizeTimer);
        state.resizeTimer = setTimeout(() => rebuildLoop(0), 150);
      }
      window.addEventListener('resize', onResize, { passive: true });
      addCleanup(() => window.removeEventListener('resize', onResize));

      // ---- Theme Editor hooks ----
      function onSectionLoad(e) {
        if (!e || !e.detail || e.detail.sectionId !== sectionId) return;
        rebuildLoop(0);
      }
      function onSectionSelect(e) {
        if (!e || !e.detail || e.detail.sectionId !== sectionId) return;
        rebuildLoop(0);
      }
      document.addEventListener('shopify:section:load', onSectionLoad);
      document.addEventListener('shopify:section:select', onSectionSelect);

      addCleanup(() => document.removeEventListener('shopify:section:load', onSectionLoad));
      addCleanup(() => document.removeEventListener('shopify:section:select', onSectionSelect));

      // Init
      rebuildLoop(0);
      state.raf = requestAnimationFrame(tick);

      function destroy() {
        if (state.raf) cancelAnimationFrame(state.raf);
        if (state.resumeTimer) clearTimeout(state.resumeTimer);
        if (state.resizeTimer) clearTimeout(state.resizeTimer);
        state.cleanup.forEach((fn) => { try { fn(); } catch (err) {} });
        root.classList.remove('is-paused');
      }

      root._myedNue = { destroy };

      document.addEventListener('shopify:section:unload', (e) => {
        if (e && e.target && e.target.contains(root)) destroy();
      }, { once: true });
    })();
  </script>
</section>

{% schema %}
{
  "name": "MyED Spotlight Legacy",
  "settings": [
    { "type": "text", "id": "heading", "label": "Heading", "default": "Best sellers" },
    { "type": "color", "id": "heading_color", "label": "Heading color", "default": "#111111" },

    {
      "type": "select",
      "id": "source",
      "label": "Source",
      "default": "manual",
      "options": [
        { "value": "manual", "label": "Manual products (blocks)" },
        { "value": "collection", "label": "Collection" }
      ]
    },

    { "type": "collection", "id": "collection", "label": "Collection" },
    { "type": "range", "id": "limit_collection", "label": "Max products (collection)", "min": 2, "max": 48, "step": 1, "default": 24 },
    { "type": "range", "id": "limit_manual", "label": "Max products (manual)", "min": 2, "max": 48, "step": 1, "default": 12 },

    { "type": "color_background", "id": "bg_color", "label": "Background color", "default": "rgba(255,255,255,1)" },
    { "type": "image_picker", "id": "bg_desktop", "label": "Background image (desktop)" },
    { "type": "image_picker", "id": "bg_mobile", "label": "Background image (mobile)" },

    { "type": "checkbox", "id": "orbit_enable", "label": "Orbit overlay (subtle)", "default": false },

    {
      "type": "select",
      "id": "aspect_ratio",
      "label": "Media aspect ratio",
      "default": "4 / 5",
      "options": [
        { "value": "1 / 1", "label": "1:1" },
        { "value": "3 / 4", "label": "3:4" },
        { "value": "4 / 5", "label": "4:5" },
        { "value": "3 / 5", "label": "3:5" }
      ]
    },
    {
      "type": "select",
      "id": "media_aspect_mobile",
      "label": "Media aspect ratio (mobile)",
      "default": "4 / 5",
      "options": [
        { "value": "1 / 1", "label": "1:1" },
        { "value": "3 / 4", "label": "3:4" },
        { "value": "4 / 5", "label": "4:5" },
        { "value": "3 / 5", "label": "3:5" }
      ]
    },

    { "type": "range", "id": "card_width_mobile", "label": "Card width (mobile px)", "min": 120, "max": 320, "step": 5, "default": 180 },
    { "type": "range", "id": "card_width_desktop", "label": "Card width (desktop px)", "min": 200, "max": 800, "step": 10, "default": 380 },

    { "type": "range", "id": "gap_mobile", "label": "Gap (mobile px)", "min": 0, "max": 40, "step": 1, "default": 10 },
    { "type": "range", "id": "gap_desktop", "label": "Gap (desktop px)", "min": 0, "max": 60, "step": 1, "default": 20 },

    { "type": "range", "id": "speed_mobile", "label": "Speed (mobile px/sec)", "min": 0, "max": 240, "step": 5, "default": 70 },
    { "type": "range", "id": "speed_desktop", "label": "Speed (desktop px/sec)", "min": 0, "max": 240, "step": 5, "default": 110 },

    { "type": "range", "id": "resume_delay", "label": "Resume delay after interaction (ms)", "min": 0, "max": 4000, "step": 100, "default": 1200 },

    { "type": "range", "id": "focus_scale", "label": "Center swell (scale %)", "min": 0, "max": 15, "step": 1, "default": 7 },

    { "type": "checkbox", "id": "pause_on_hover", "label": "Pause on hover (desktop)", "default": true },
    { "type": "checkbox", "id": "show_title", "label": "Show product title (hover/tap)", "default": true },

    { "type": "checkbox", "id": "debug", "label": "Debug logs (console)", "default": false }
  ],
  "blocks": [
    {
      "type": "product",
      "name": "Product",
      "settings": [
        { "type": "product", "id": "product", "label": "Product" }
      ]
    }
  ]
}
{% endschema %}
