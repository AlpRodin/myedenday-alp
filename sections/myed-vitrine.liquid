{%- comment -%}
  MyED — Vitrine (OS 2.0)
  Showroom shelf scene with clickable product slots.
  - Desktop/Tablet: deterministic shelf lineup
  - Mobile: horizontal strip with scroll-snap
{%- endcomment -%}

{{ 'myed-vitrine.css' | asset_url | stylesheet_tag }}
{{ 'myed-vitrine-scene.css' | asset_url | stylesheet_tag }}
<script src="{{ 'myed-vitrine.js' | asset_url }}" defer="defer"></script>

{%- liquid
  assign section_id = section.id
  assign visual_mode = section.settings.visual_mode | default: 'auto'
  assign cta_mode = section.settings.cta_mode | default: 'auto'

  assign spot_a = section.settings.spot_intensity | default: 42 | times: 0.01
  assign beam_a = section.settings.beam_intensity | default: 34 | times: 0.01
  assign vig_a = section.settings.vignette_intensity | default: 42 | times: 0.01
  assign floor_a = section.settings.floor_reflection | default: 55 | times: 0.01
  assign spot_left_x = section.settings.spot_left_x | default: 34
  assign spot_right_x = section.settings.spot_right_x | default: 68

  assign scene_bg_css = 'none'
  if section.settings.scene_bg != blank
    assign scene_bg_url = section.settings.scene_bg | image_url: width: 2600
    assign scene_bg_css = "url('" | append: scene_bg_url | append: "')"
  endif

  assign kicker_s = section.settings.kicker | default: '' | strip
  assign heading_s = section.settings.heading | default: '' | strip
  assign subheading_s = section.settings.subheading | default: '' | strip

  assign product_slot_count = 0
  assign selected_slot_index = 0
  assign selected_slot_locked = false

  for block in section.blocks
    if block.type == 'product' and block.settings.product != blank
      assign product_slot_count = product_slot_count | plus: 1
      if selected_slot_locked == false and block.settings.is_default
        assign selected_slot_index = product_slot_count
        assign selected_slot_locked = true
      endif
    endif
  endfor

  if selected_slot_index == 0 and product_slot_count > 0
    assign selected_slot_index = 1
  endif

  assign slot_columns = product_slot_count
  if slot_columns < 1
    assign slot_columns = 1
  endif
-%}

<myed-vitrine
  class="myed-vitrine myed-vitrine--ready"
  data-section-id="{{ section_id }}"
  data-vmode="{{ visual_mode }}"
  data-cta-mode="{{ cta_mode }}"
  data-selected-index="{{ selected_slot_index }}"
  style="
    --myed-spot-a: {{ spot_a }};
    --myed-beam-a: {{ beam_a }};
    --myed-vig-a: {{ vig_a }};
    --myed-floor-a: {{ floor_a }};
    --myed-spot-left-x: {{ spot_left_x }}%;
    --myed-spot-right-x: {{ spot_right_x }}%;
    --myed-scene-bg: {{ scene_bg_css }};
    --myed-shelf-y: {{ section.settings.shelf_y | default: 73 }}%;
    --myed-shelf-h: {{ section.settings.shelf_h | default: 140 }}px;
    --myed-shelf-face-h: var(--myed-shelf-h);
  "
>
  <div class="myed-vitrine__surface" role="region" aria-label="Vitrine">
    <div class="myed-vitrine__stage">
      <div class="myed-vitrine__stage-inner">

        {%- if kicker_s != '' or heading_s != '' or subheading_s != '' -%}
          <div class="myed-vitrine__header">
            {%- if kicker_s != '' -%}
              <div class="myed-vitrine__kicker">{{ kicker_s | escape }}</div>
            {%- endif -%}
            {%- if heading_s != '' -%}
              <h2 class="myed-vitrine__heading">{{ heading_s | escape }}</h2>
            {%- endif -%}
            {%- if subheading_s != '' -%}
              <div class="myed-vitrine__subheading">{{ subheading_s | escape }}</div>
            {%- endif -%}
          </div>
        {%- endif -%}

        <div class="myed-vitrine__fx" aria-hidden="true"></div>
        <div class="myed-vitrine__floor-fade" aria-hidden="true"></div>
        <div class="myed-vitrine__shelf" aria-hidden="true"></div>

        <div class="myed-vitrine__shelfline" role="list" style="--myed-slot-count: {{ slot_columns }};">
          {%- assign slot_index = 0 -%}
          {%- for block in section.blocks -%}
            {%- if block.type == 'product' and block.settings.product != blank -%}
              {%- assign slot_index = slot_index | plus: 1 -%}
              {%- assign slot_product = block.settings.product -%}
              {%- assign slot_media = slot_product.featured_media -%}
              {%- assign modal_desc_html = block.settings.modal_desc | default: '' | strip -%}
              {%- assign scene_label_s = block.settings.scene_label | default: '' | strip -%}
              {%- assign is_selected = false -%}
              {%- if slot_index == selected_slot_index -%}{%- assign is_selected = true -%}{%- endif -%}

              <div class="myed-vitrine__slot{% if is_selected %} is-selected{% endif %}" role="listitem" data-slot-index="{{ slot_index }}" {{ block.shopify_attributes }}>
                <button
                  class="myed-vitrine__slot-btn"
                  {%- if slot_media != blank -%}
                    style="--myed-slot-img: url('{{ slot_media | image_url: width: 700 }}');"
                  {%- endif -%}
                  type="button"
                  data-myed-slot
                  data-product-handle="{{ slot_product.handle }}"
                  data-product-url="{{ slot_product.url }}"
                  data-product-title="{{ slot_product.title | escape }}"
                  data-slot-index="{{ slot_index }}"
                  aria-pressed="{% if is_selected %}true{% else %}false{% endif %}"
                  aria-label="{{ slot_product.title | escape }}"
                >
                  {%- if slot_media != blank -%}
                    <img
                      src="{{ slot_media | image_url: width: 560 }}"
                      srcset="
                        {{ slot_media | image_url: width: 240 }} 240w,
                        {{ slot_media | image_url: width: 320 }} 320w,
                        {{ slot_media | image_url: width: 420 }} 420w,
                        {{ slot_media | image_url: width: 560 }} 560w
                      "
                      sizes="(min-width: 990px) 16vw, (min-width: 750px) 18vw, 44vw"
                      alt="{{ slot_media.alt | default: slot_product.title | escape }}"
                      loading="lazy"
                      width="{{ slot_media.width }}"
                      height="{{ slot_media.height }}"
                    >
                  {%- endif -%}

                  {%- if block.settings.badge != blank -%}
                    <span class="myed-vitrine__slot-badge">{{ block.settings.badge | escape }}</span>
                  {%- endif -%}
                </button>

                {%- if block.settings.show_scene_label and scene_label_s != '' -%}
                  <div class="myed-vitrine__scene-label">{{ scene_label_s | escape }}</div>
                {%- endif -%}

                <script type="application/json" id="myed-vt-slot-{{ section.id }}-{{ slot_index }}">
                  {
                    "index": {{ slot_index }},
                    "title": {{ slot_product.title | json }},
                    "url": {{ slot_product.url | json }},
                    "images": [
                      {%- assign image_count = 0 -%}
                      {%- for media in slot_product.media -%}
                        {%- if media.media_type == 'image' and image_count < 4 -%}
                          {%- if image_count > 0 -%},{%- endif -%}
                          {
                            "src": {{ media | image_url: width: 1400 | json }},
                            "alt": {{ media.alt | default: slot_product.title | json }}
                          }
                          {%- assign image_count = image_count | plus: 1 -%}
                        {%- endif -%}
                      {%- endfor -%}
                    ],
                    "product_desc_html": {{ slot_product.description | default: '' | json }},
                    "extra_desc_html": {{ modal_desc_html | json }}
                  }
                </script>
              </div>

              {%- if slot_index >= 6 -%}{% break %}{%- endif -%}
            {%- endif -%}
          {%- endfor -%}
        </div>

      </div>
    </div>
  </div>

  <div class="myed-vitrine__modal" hidden aria-hidden="true">
    <div class="myed-vitrine__backdrop" data-myed-modal-close></div>
    <div class="myed-vitrine__dialog" role="dialog" aria-modal="true" aria-label="Product details">
      <button class="myed-vitrine__modal-close" type="button" data-myed-modal-close aria-label="Close">&times;</button>
      <div class="myed-vitrine__modal-body">
        <div class="myed-vitrine__modal-media">
          <button class="myed-vitrine__nav myed-vitrine__nav--prev" type="button" data-myed-prev aria-label="Previous">&lsaquo;</button>
          <div class="myed-vitrine__viewport">
            <img class="myed-vitrine__modal-img" alt="" loading="lazy" decoding="async" width="1400" height="1750">
          </div>
          <button class="myed-vitrine__nav myed-vitrine__nav--next" type="button" data-myed-next aria-label="Next">&rsaquo;</button>
          <div class="myed-vitrine__dots" data-myed-dots></div>
        </div>
        <div class="myed-vitrine__modal-content">
          <div class="myed-vitrine__modal-title" data-myed-title></div>
          <div class="myed-vitrine__modal-desc rte" data-myed-desc></div>
          <a class="myed-vitrine__modal-cta" data-myed-cta href="#">View product</a>
        </div>
      </div>
    </div>
  </div>
</myed-vitrine>

{% schema %}
{
  "name": "MyED — Vitrine",
  "tag": "section",
  "class": "myed-vitrine-section",
  "settings": [
    { "type": "text", "id": "kicker", "label": "Kicker" },
    { "type": "text", "id": "heading", "label": "Heading" },
    { "type": "text", "id": "subheading", "label": "Subheading" },

    {
      "type": "select",
      "id": "visual_mode",
      "label": "Visual mode",
      "default": "auto",
      "options": [
        { "value": "auto", "label": "Auto" },
        { "value": "exact", "label": "Exact" },
        { "value": "brand", "label": "Brand" },
        { "value": "lite", "label": "Lite" }
      ]
    },
    {
      "type": "select",
      "id": "cta_mode",
      "label": "CTA mode",
      "default": "auto",
      "options": [
        { "value": "auto", "label": "Auto" },
        { "value": "ajax", "label": "Ajax" },
        { "value": "product", "label": "Product page" },
        { "value": "drawer", "label": "Cart drawer" }
      ]
    },

    { "type": "image_picker", "id": "scene_bg", "label": "Scene background image" },

    { "type": "range", "id": "spot_intensity", "label": "Spot intensity", "min": 0, "max": 100, "step": 1, "default": 42 },
    { "type": "range", "id": "beam_intensity", "label": "Beam intensity", "min": 0, "max": 100, "step": 1, "default": 34 },
    { "type": "range", "id": "vignette_intensity", "label": "Vignette intensity", "min": 0, "max": 100, "step": 1, "default": 42 },
    { "type": "range", "id": "floor_reflection", "label": "Floor reflection", "min": 0, "max": 100, "step": 1, "default": 55 },

    { "type": "range", "id": "spot_left_x", "label": "Spot left X (%)", "min": 10, "max": 90, "step": 1, "default": 34 },
    { "type": "range", "id": "spot_right_x", "label": "Spot right X (%)", "min": 10, "max": 90, "step": 1, "default": 68 },

    { "type": "range", "id": "shelf_y", "label": "Shelf vertical position (%)", "min": 55, "max": 85, "step": 1, "default": 73 },
    { "type": "range", "id": "shelf_h", "label": "Shelf height (px)", "min": 80, "max": 190, "step": 5, "default": 140 }
  ],
  "blocks": [
    {
      "type": "product",
      "name": "Product",
      "limit": 6,
      "settings": [
        { "type": "product", "id": "product", "label": "Product" },
        { "type": "text", "id": "badge", "label": "Badge (optional)", "default": "PREMIUM" },
        { "type": "checkbox", "id": "is_default", "label": "Default selected", "default": false },
        { "type": "checkbox", "id": "show_scene_label", "label": "Show scene label", "default": false },
        { "type": "text", "id": "scene_label", "label": "Scene label" },
        { "type": "richtext", "id": "modal_desc", "label": "Extra item content (optional)" }
      ]
    }
  ],
  "presets": [
    {
      "name": "MyED — Vitrine",
      "blocks": [
        { "type": "product" },
        { "type": "product" },
        { "type": "product" },
        { "type": "product" },
        { "type": "product" }
      ]
    }
  ]
}
{% endschema %}