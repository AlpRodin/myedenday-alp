{% comment %}
  MyED — NUE Product Slider (Butter-smooth transform ticker)
  - Collection OR Manual products (blocks)
  - Background image + orbit overlay
  - Pause on hover (desktop), drag on touch, infinite loop
  - Center "heart" scale
  - No Swiper / no external libs
{% endcomment %}

{{ 'myed-nue-product-slider.css' | asset_url | stylesheet_tag }}

{%- liquid
  assign s = section.settings
  assign source = s.source
-%}

<section
  id="myed-nue-{{ section.id }}"
  class="myed-nue{% if s.orbit_enable %} has-orbit{% endif %}"
  style="background: {{ s.bg_color }};"
  data-section-id="{{ section.id }}"
  data-myed-nue
>
  {%- if s.bg_image != blank -%}
    <div class="myed-nue__bg" aria-hidden="true">
      {{ s.bg_image
        | image_url: width: 2600
        | image_tag: loading: 'lazy', decoding: 'async', alt: ''
      }}
    </div>
  {%- endif -%}

  {%- if s.orbit_enable -%}
    <div class="myed-nue__orbit" aria-hidden="true"></div>
  {%- endif -%}

  <div class="myed-nue__inner">
    {%- if s.heading != blank -%}
      <h2 class="myed-nue__heading">{{ s.heading }}</h2>
    {%- endif -%}

    <div
      class="myed-nue__viewport"
      data-myed-nue-viewport
      style="
        --myed-ar: {{ s.aspect_ratio }};
        --myed-fit: {{ s.image_fit }};
        --myed-card-w: {{ s.card_width_desktop }}px;
        --myed-card-w-m: {{ s.card_width_mobile }}px;
        --myed-gap: {{ s.gap_desktop }}px;
        --myed-bg-opacity: {{ s.bg_opacity | divided_by: 100.0 }};
        --myed-bg-blur: {{ s.bg_blur }}px;
        --myed-bg-scale: {{ s.bg_scale | divided_by: 100.0 }};
        --myed-orbit-opacity: {{ s.orbit_opacity | divided_by: 100.0 }};
        --myed-orbit-speed: {{ s.orbit_speed }}s;
      "
    >
      <div class="myed-nue__track" data-myed-nue-track>
        <div class="myed-nue__group" data-myed-nue-group-a>
          {%- if source == 'collection' -%}
            {%- if s.collection != blank -%}
              {%- for product in s.collection.products limit: s.limit_collection -%}
                {%- liquid
                  assign img = product.featured_image
                  if img == blank and product.featured_media != blank
                    assign img = product.featured_media.preview_image
                  endif
                -%}
                <div class="myed-nue__item" data-myed-nue-item>
                  <div class="myed-nue__itemInner">
                    <a class="myed-nue__link" href="{{ product.url }}" aria-label="{{ product.title | escape }}">
                      <div class="myed-nue__media">
                        {%- if img != blank -%}
                          {{ img | image_url: width: 1400 | image_tag: loading: 'lazy', decoding: 'async', alt: product.title }}
                        {%- else -%}
                          {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
                        {%- endif -%}
                      </div>
                      {%- if s.show_title -%}
                        <p class="myed-nue__title">{{ product.title }}</p>
                      {%- endif -%}
                    </a>
                  </div>
                </div>
              {%- endfor -%}
            {%- else -%}
              {%- for i in (1..8) -%}
                <div class="myed-nue__item" data-myed-nue-item>
                  <div class="myed-nue__itemInner">
                    <a class="myed-nue__link" href="#" aria-label="Product {{ i }}">
                      <div class="myed-nue__media">
                        {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
                      </div>
                      {%- if s.show_title -%}
                        <p class="myed-nue__title">Product {{ i }}</p>
                      {%- endif -%}
                    </a>
                  </div>
                </div>
              {%- endfor -%}
            {%- endif -%}

          {%- else -%} {% comment %} manual via blocks {% endcomment %}
            {%- assign count = 0 -%}
            {%- for block in section.blocks -%}
              {%- if block.type == 'product' and block.settings.product != blank -%}
                {%- assign count = count | plus: 1 -%}
                {%- if count <= s.limit_manual -%}
                  {%- assign product = block.settings.product -%}
                  {%- liquid
                    assign img = product.featured_image
                    if img == blank and product.featured_media != blank
                      assign img = product.featured_media.preview_image
                    endif
                  -%}
                  <div class="myed-nue__item" data-myed-nue-item {{ block.shopify_attributes }}>
                    <div class="myed-nue__itemInner">
                      <a class="myed-nue__link" href="{{ product.url }}" aria-label="{{ product.title | escape }}">
                        <div class="myed-nue__media">
                          {%- if img != blank -%}
                            {{ img | image_url: width: 1400 | image_tag: loading: 'lazy', decoding: 'async', alt: product.title }}
                          {%- else -%}
                            {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
                          {%- endif -%}
                        </div>
                        {%- if s.show_title -%}
                          <p class="myed-nue__title">{{ product.title }}</p>
                        {%- endif -%}
                      </a>
                    </div>
                  </div>
                {%- endif -%}
              {%- endif -%}
            {%- endfor -%}

            {%- if count == 0 -%}
              {%- for i in (1..8) -%}
                <div class="myed-nue__item" data-myed-nue-item>
                  <div class="myed-nue__itemInner">
                    <a class="myed-nue__link" href="#" aria-label="Product {{ i }}">
                      <div class="myed-nue__media">
                        {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
                      </div>
                      {%- if s.show_title -%}
                        <p class="myed-nue__title">Manual Product {{ i }}</p>
                      {%- endif -%}
                    </a>
                  </div>
                </div>
              {%- endfor -%}
            {%- endif -%}
          {%- endif -%}
        </div>

        <div class="myed-nue__group" data-myed-nue-group-b aria-hidden="true"></div>
      </div>
    </div>
  </div>

  <script>
    (() => {
      const root = document.getElementById('myed-nue-{{ section.id }}');
      if (!root) return;

      const sectionId = root.dataset.sectionId;

      // Kill previous instance if re-rendered
      if (root._myedNue && typeof root._myedNue.destroy === 'function') {
        root._myedNue.destroy();
      }

      const viewport = root.querySelector('[data-myed-nue-viewport]');
      const track = root.querySelector('[data-myed-nue-track]');
      const groupA = root.querySelector('[data-myed-nue-group-a]');
      const groupB = root.querySelector('[data-myed-nue-group-b]');
      if (!viewport || !track || !groupA || !groupB) return;

      const prefersReduced = () =>
        window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

      const isMobile = () =>
        window.matchMedia && window.matchMedia('(max-width: 749px)').matches;

      const canHover = () =>
        window.matchMedia && window.matchMedia('(hover:hover)').matches;

      const settings = {
        speedMobile: Number({{ section.settings.speed_mobile | json }}) || 80,
        speedDesktop: Number({{ section.settings.speed_desktop | json }}) || 120,
        resumeDelay: Number({{ section.settings.resume_delay | json }}) || 2000,
        pauseOnHover: Boolean({{ section.settings.pause_on_hover | json }}),
        focusScalePct: Number({{ section.settings.focus_scale | json }}) || 7
      };

      const inst = {
        raf: null,
        lastTs: 0,
        offset: 0,
        loopWidth: 0,
        dragging: false,
        hoverPause: false,
        inView: true,
        resumeTimer: null,
        resizeTimer: null,
        observer: null,
        startX: 0,
        startOffset: 0,
        moved: false,
        cleanup: []
      };

      const addCleanup = (fn) => inst.cleanup.push(fn);

      function setPausedClass(paused) {
        root.classList.toggle('is-paused', !!paused);
      }

      function getSpeed() {
        return isMobile() ? settings.speedMobile : settings.speedDesktop;
      }

      function applyTransform() {
        // translate3d for buttery smooth
        track.style.transform = `translate3d(${inst.offset}px, 0, 0)`;
      }

      function normalizeOffset() {
        if (!inst.loopWidth) return;
        // Keep offset within (-loopWidth, 0] via modulo normalization.
        inst.offset = ((inst.offset % inst.loopWidth) + inst.loopWidth) % inst.loopWidth;
        if (inst.offset > 0) inst.offset -= inst.loopWidth;
      }

      function applyCenterScale() {
        const items = root.querySelectorAll('[data-myed-nue-item]');
        if (!items || !items.length) return;

        const vp = viewport.getBoundingClientRect();
        const centerX = vp.left + vp.width / 2;
        const half = Math.max(1, vp.width / 2);
        const peak = Math.max(0, settings.focusScalePct) / 100;

        for (const item of items) {
          const r = item.getBoundingClientRect();
          const c = r.left + r.width / 2;
          const d = Math.abs(centerX - c);
          const t = Math.min(d / half, 1);               // 0 center -> 1 edge
          const s = 1 + peak * (1 - t);                 // peak at center
          item.style.setProperty('--myed-scale', s.toFixed(3));
        }
      }

      function shouldRun() {
        if (prefersReduced()) return false;
        if (!inst.inView) return false;
        if (inst.dragging) return false;
        if (inst.hoverPause) return false;
        return true;
      }

      function tick(ts) {
        inst.raf = requestAnimationFrame(tick);

        // cap dt to avoid huge jumps after tab inactive
        const dt = inst.lastTs ? Math.min(ts - inst.lastTs, 32) : 16;
        inst.lastTs = ts;

        if (shouldRun()) {
          inst.offset -= (getSpeed() / 1000) * dt;
          normalizeOffset();
          applyTransform();
        } else {
          // still keep transform stable
          applyTransform();
        }

        // center scale can run even while paused/dragging
        applyCenterScale();
      }

      function resumeAfterDelay() {
        if (inst.resumeTimer) clearTimeout(inst.resumeTimer);
        inst.resumeTimer = setTimeout(() => {
          if (!inst.dragging) {
            inst.hoverPause = false; // only affects hover resume as well
            setPausedClass(false);
          }
        }, settings.resumeDelay);
      }

      function markClone(el) {
        el.setAttribute('data-clone', 'true');
        el.setAttribute('aria-hidden', 'true');

        const focusables = el.querySelectorAll('a, button, input, select, textarea, [tabindex]');
        for (const node of focusables) {
          node.setAttribute('tabindex', '-1');
          node.setAttribute('aria-hidden', 'true');
        }
      }

      function ensureLoopFill() {
        // Reset to original content then append clones until 2.2x viewport width.
        if (!groupA._originalHTML) groupA._originalHTML = groupA.innerHTML;
        groupA.innerHTML = groupA._originalHTML;

        inst.loopWidth = groupA.scrollWidth;
        const minW = viewport.clientWidth * 2.2;

        let guard = 0;
        while (inst.loopWidth < minW && guard < 8) {
          const originals = Array.from(groupA.children);
          for (const item of originals) {
            const clone = item.cloneNode(true);
            markClone(clone);
            groupA.appendChild(clone);
          }
          inst.loopWidth = groupA.scrollWidth;
          guard += 1;
        }

        // Clone A into B for seamless wrap, mark all as clones.
        groupB.innerHTML = groupA.innerHTML;
        const groupBItems = Array.from(groupB.children);
        for (const item of groupBItems) markClone(item);
      }

      function buildLoop() {
        // Update gap variable per breakpoint (optional: you already control via settings)
        const gap = isMobile() ? Number({{ section.settings.gap_mobile | json }}) : Number({{ section.settings.gap_desktop | json }});
        viewport.style.setProperty('--myed-gap', `${gap}px`);

        // Ensure enough content width (critical when only 2-3 products)
        ensureLoopFill();

        // reset offset safely
        inst.offset = 0;
        normalizeOffset();
        applyTransform();
        applyCenterScale();
      }

      // ---- Drag (works on mobile + desktop) ----
      function onPointerDown(e) {
        if (e.pointerType === 'mouse' && e.button !== 0) return;

        inst.dragging = true;
        inst.moved = false;
        inst.startX = e.clientX;
        inst.startOffset = inst.offset;

        viewport.classList.add('is-dragging');
        inst.hoverPause = true; // treat as paused
        setPausedClass(true);

        try { viewport.setPointerCapture(e.pointerId); } catch (err) {}
      }

      function onPointerMove(e) {
        if (!inst.dragging) return;

        const dx = e.clientX - inst.startX;
        if (Math.abs(dx) > 3) inst.moved = true;

        inst.offset = inst.startOffset + dx;
        normalizeOffset();
        applyTransform();
        applyCenterScale();
      }

      function onPointerUp() {
        if (!inst.dragging) return;

        inst.dragging = false;
        viewport.classList.remove('is-dragging');

        // Resume after delay
        resumeAfterDelay();
      }

      viewport.addEventListener('pointerdown', onPointerDown, { passive: true });
      window.addEventListener('pointermove', onPointerMove, { passive: true });
      window.addEventListener('pointerup', onPointerUp, { passive: true });
      window.addEventListener('pointercancel', onPointerUp, { passive: true });

      addCleanup(() => viewport.removeEventListener('pointerdown', onPointerDown));
      addCleanup(() => window.removeEventListener('pointermove', onPointerMove));
      addCleanup(() => window.removeEventListener('pointerup', onPointerUp));
      addCleanup(() => window.removeEventListener('pointercancel', onPointerUp));

      // Prevent accidental click when dragging
      function onClickCapture(e) {
        if (inst.moved) {
          e.preventDefault();
          e.stopPropagation();
        }
      }
      viewport.addEventListener('click', onClickCapture, true);
      addCleanup(() => viewport.removeEventListener('click', onClickCapture, true));

      // ---- Hover pause (desktop only) ----
      if (settings.pauseOnHover && canHover()) {
        const onEnter = () => {
          if (isMobile()) return;
          inst.hoverPause = true;
          setPausedClass(true);
        };
        const onLeave = () => {
          if (isMobile()) return;
          inst.hoverPause = false;
          resumeAfterDelay();
        };

        viewport.addEventListener('mouseenter', onEnter);
        viewport.addEventListener('mouseleave', onLeave);

        addCleanup(() => viewport.removeEventListener('mouseenter', onEnter));
        addCleanup(() => viewport.removeEventListener('mouseleave', onLeave));
      }

      // ---- Viewport visibility pause (performance) ----
      if ('IntersectionObserver' in window) {
        inst.observer = new IntersectionObserver((entries) => {
          const entry = entries && entries[0];
          if (!entry) return;
          inst.inView = !!entry.isIntersecting;
        }, { threshold: 0.05 });
        inst.observer.observe(root);
      }

      // ---- Resize rebuild (debounced) ----
      function onResize() {
        if (inst.resizeTimer) clearTimeout(inst.resizeTimer);
        inst.resizeTimer = setTimeout(() => buildLoop(), 150);
      }
      window.addEventListener('resize', onResize, { passive: true });
      addCleanup(() => window.removeEventListener('resize', onResize));

      // ---- Theme Editor load hook ----
      function onSectionLoad(event) {
        if (!event || !event.detail || event.detail.sectionId !== sectionId) return;
        buildLoop();
      }
      document.addEventListener('shopify:section:load', onSectionLoad);
      addCleanup(() => document.removeEventListener('shopify:section:load', onSectionLoad));

      // Init
      buildLoop();
      inst.raf = requestAnimationFrame(tick);

      // Shopify editor cleanup
      function destroy() {
        if (inst.raf) cancelAnimationFrame(inst.raf);
        if (inst.resumeTimer) clearTimeout(inst.resumeTimer);
        if (inst.resizeTimer) clearTimeout(inst.resizeTimer);
        if (inst.observer) inst.observer.disconnect();
        for (const fn of inst.cleanup) { try { fn(); } catch(e){} }
        root.classList.remove('is-paused');
      }

      root._myedNue = { destroy };

      document.addEventListener('shopify:section:unload', (event) => {
        if (event && event.target && event.target.contains(root)) destroy();
      }, { once: true });

    })();
  </script>
</section>

{% schema %}
{
  "name": "MyED — NUE Product Slider",
  "settings": [
    { "type": "text", "id": "heading", "label": "Heading", "default": "Best sellers" },

    {
      "type": "select",
      "id": "source",
      "label": "Source",
      "default": "manual",
      "options": [
        { "value": "manual", "label": "Manual products (blocks)" },
        { "value": "collection", "label": "Collection" }
      ]
    },

    { "type": "collection", "id": "collection", "label": "Collection" },
    { "type": "range", "id": "limit_collection", "label": "Max products (collection)", "min": 2, "max": 48, "step": 1, "default": 24 },
    { "type": "range", "id": "limit_manual", "label": "Max products (manual)", "min": 2, "max": 48, "step": 1, "default": 12 },

    { "type": "color_background", "id": "bg_color", "label": "Background color", "default": "rgba(255,255,255,1)" },
    { "type": "image_picker", "id": "bg_image", "label": "Background image (optional)" },
    { "type": "range", "id": "bg_opacity", "label": "BG image opacity (%)", "min": 0, "max": 100, "step": 1, "default": 100 },
    { "type": "range", "id": "bg_blur", "label": "BG image blur (px)", "min": 0, "max": 24, "step": 1, "default": 0 },
    { "type": "range", "id": "bg_scale", "label": "BG image scale (%)", "min": 80, "max": 140, "step": 1, "default": 100 },

    { "type": "checkbox", "id": "orbit_enable", "label": "Orbit overlay (subtle)", "default": false },
    { "type": "range", "id": "orbit_opacity", "label": "Orbit opacity (%)", "min": 0, "max": 100, "step": 1, "default": 30 },
    { "type": "range", "id": "orbit_speed", "label": "Orbit speed (seconds)", "min": 10, "max": 180, "step": 2, "default": 60 },

    {
      "type": "select",
      "id": "image_fit",
      "label": "Image fit",
      "default": "contain",
      "options": [
        { "value": "contain", "label": "Contain" },
        { "value": "cover", "label": "Cover" }
      ]
    },

    { "type": "text", "id": "aspect_ratio", "label": "aspect_ratio", "default": "3 / 5" },

    { "type": "range", "id": "card_width_mobile", "label": "card width mobile (px)", "min": 120, "max": 320, "step": 5, "default": 180 },
    { "type": "range", "id": "card_width_desktop", "label": "card width desktop (px)", "min": 200, "max": 800, "step": 10, "default": 380 },

    { "type": "range", "id": "gap_mobile", "label": "Gap (mobile px)", "min": 0, "max": 40, "step": 1, "default": 10 },
    { "type": "range", "id": "gap_desktop", "label": "Gap (desktop px)", "min": 0, "max": 60, "step": 1, "default": 20 },

    { "type": "range", "id": "speed_mobile", "label": "speed mobile (px/sec)", "min": 0, "max": 300, "step": 5, "default": 80 },
    { "type": "range", "id": "speed_desktop", "label": "speed desktop (px/sec)", "min": 0, "max": 300, "step": 5, "default": 120 },

    { "type": "range", "id": "resume_delay", "label": "Resume delay after interaction (ms)", "min": 0, "max": 4000, "step": 100, "default": 1200 },

    { "type": "range", "id": "focus_scale", "label": "Center swell (scale %)", "min": 0, "max": 15, "step": 1, "default": 7 },

    { "type": "checkbox", "id": "pause_on_hover", "label": "Pause on hover (desktop)", "default": true },
    { "type": "checkbox", "id": "show_title", "label": "Show product title", "default": true }
  ],
  "blocks": [
    {
      "type": "product",
      "name": "Product",
      "settings": [
        { "type": "product", "id": "product", "label": "Product" }
      ]
    }
  ],
  "presets": [
    { "name": "MyED — NUE Product Slider" }
  ]
}
{% endschema %}
